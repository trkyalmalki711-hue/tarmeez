{% include "partials/header.html" %}

<div class="card section" style="margin-top:18px">

  <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px">
    <div>
      <h3>Dictionary</h3>
      <div class="small">Search CPT & ICD codes with clean results</div>
    </div>

    <div class="actions">
      <button id="btn-cpt" class="btn btnPrimary" onclick="setKind('cpt')">CPT</button>
      <button id="btn-icd" class="btn btnGhost" onclick="setKind('icd')">ICD</button>
    </div>
  </div>

  <div style="margin-top:14px">
    <input
      id="q"
      class="input"
      type="text"
      placeholder="Search code or description..."
      oninput="search()"
    >
  </div>

  <div id="results" style="margin-top:16px"></div>

</div>

<script>
  let kind = "cpt";
  let timer = null;

  function setKind(k){
    kind = k;
    document.getElementById("results").innerHTML = "";
    document.getElementById("btn-cpt").className =
      k === "cpt" ? "btn btnPrimary" : "btn btnGhost";
    document.getElementById("btn-icd").className =
      k === "icd" ? "btn btnPrimary" : "btn btnGhost";
  }

  function search(){
    clearTimeout(timer);
    timer = setTimeout(async () => {
      const q = document.getElementById("q").value.trim();
      if(q.length < 2){
        document.getElementById("results").innerHTML = "";
        return;
      }

      try{
        const res = await fetch(`/search/${kind}?q=${encodeURIComponent(q)}`);
        const data = await res.json();

        if(!data.results || data.results.length === 0){
          document.getElementById("results").innerHTML =
            `<div class="small">No results found</div>`;
          return;
        }

        document.getElementById("results").innerHTML =
          data.results.map(r => `
            <div class="card section" style="margin-bottom:10px">
              <div style="display:flex; justify-content:space-between; gap:12px">
                <strong>${r.code}</strong>
                <span class="small">${kind.toUpperCase()}</span>
              </div>
              <div class="small" style="margin-top:6px">
                ${r.description || ""}
              </div>
            </div>
          `).join("");

      }catch(e){
        document.getElementById("results").innerHTML =
          `<div class="small" style="color:var(--bad)">Error loading results</div>`;
      }
    }, 300); // debounce
  }
</script>

{% include "partials/footer.html" %}
